{
  "hash": "00db02d076ecdf85bd0b4a37f471b1ce",
  "result": {
    "markdown": "---\ntitle: \"Time series box plot using R's ggplot2\"\ndate: 2023-05-25\ncategories: [R, ggplot2, chart junk, time series]\n---\n\n::: {.cell}\n\n:::\n\n\n\nBefore you start, know that this one is firmly in the \"chart junk\" category.\n\nIn a situation where I want to quickly view differences between some grouped data, I may use a box plot. A thick line in the center shows the mean, and the box itself displays the 25th-75th quartiles. The whiskers extend out to the observation no farther than 1.5 times this range. From [`?ggplot2::geom_boxplot`](https://ggplot2.tidyverse.org/reference/geom_boxplot.html#ref-examples):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(mpg, aes(hwy, class)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nAlternately, if I have a sequence of observations, I may use a line to connect them and visualize how the data change over time. From [`?ggplot2::geom_line`](https://ggplot2.tidyverse.org/reference/geom_path.html#ref-examples):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(economics_long, aes(date, value01, colour = variable)) +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nBut... what if I have grouped data that follow each other in time? Beyond committing what may be a statistical sin, how could I visualize this situation?\n\nOur lab group does a lot of before-after-control-impact (BACI) studies. Because of this, we've taken to visualizing any changes during our experiments using box plots that show group behavior before, during, and after the experiment. This does assume that the observations are independent, which they aren't; we have multiple observations for each individual which correlated through time. I wanted to be able to see what the time series for each individual was within the box I've just put them in.\n\nSo, here's how I created the unholy union of a time series and a box plot, overlaying each individual time series on a box and whisker plot.\n\n## Let's make some dummy data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2); library(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nmy_data <- tibble(\n  # Create five individuals with 15 measurements each\n  individual = rep(letters[1:5], each = 15),\n  \n  # Create a time for each of the 15 measurements\n  time = rep(\n    seq.POSIXt(ISOdate(2020, 02, 03), by = 'min', length.out = 15),\n    times = 5),\n  \n  # Group by experimental phase\n  phase = factor(\n    rep(\n      c('Before', 'Impact', 'After'), each = 5, times = 5\n    ),\n    ordered = T,\n    levels = c('Before', 'Impact', 'After')\n  )\n) |> \n  rowwise() |> \n  mutate(\n    # make fake data\n    value = ifelse(phase %in% c('Before', 'After'),\n                         rnorm(1), rnorm(1, mean = -2))\n  )\n\nmy_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 75 × 4\n# Rowwise: \n   individual time                phase   value\n   <chr>      <dttm>              <ord>   <dbl>\n 1 a          2020-02-03 12:00:00 Before  0.389\n 2 a          2020-02-03 12:01:00 Before -0.816\n 3 a          2020-02-03 12:02:00 Before -0.288\n 4 a          2020-02-03 12:03:00 Before  0.601\n 5 a          2020-02-03 12:04:00 Before  0.332\n 6 a          2020-02-03 12:05:00 Impact -0.707\n 7 a          2020-02-03 12:06:00 Impact -3.67 \n 8 a          2020-02-03 12:07:00 Impact -2.08 \n 9 a          2020-02-03 12:08:00 Impact -0.221\n10 a          2020-02-03 12:09:00 Impact -2.03 \n# ℹ 65 more rows\n```\n:::\n:::\n\n\nEventually, we'll want to find where, exactly, an observation falls in a given phase's timeline. To do this, we'll find start/end time for each trial phase and join them back in.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data <- my_data |> \n  group_by(phase) |> \n  summarize(time.start = min(time),\n            time.end = max(time)) |> \n  right_join(my_data)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(phase)`\n```\n:::\n\n```{.r .cell-code}\nmy_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 75 × 6\n   phase  time.start          time.end            individual time               \n   <ord>  <dttm>              <dttm>              <chr>      <dttm>             \n 1 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 a          2020-02-03 12:00:00\n 2 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 a          2020-02-03 12:01:00\n 3 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 a          2020-02-03 12:02:00\n 4 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 a          2020-02-03 12:03:00\n 5 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 a          2020-02-03 12:04:00\n 6 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 b          2020-02-03 12:00:00\n 7 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 b          2020-02-03 12:01:00\n 8 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 b          2020-02-03 12:02:00\n 9 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 b          2020-02-03 12:03:00\n10 Before 2020-02-03 12:00:00 2020-02-03 12:04:00 b          2020-02-03 12:04:00\n# ℹ 65 more rows\n# ℹ 1 more variable: value <dbl>\n```\n:::\n:::\n\n\nPOSIX dates are the number of seconds since midnight on Jan 1, 1970. While we can't do easy math on a date, we can easily use the number of seconds. Let's convert the POSIX dates to numeric; we can use this to translate each time series to a different scale in the next step, below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data <- my_data |> \n  mutate_at(vars(starts_with('time')),\n            as.numeric)\n\nmy_data\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 75 × 6\n   phase  time.start   time.end individual       time  value\n   <ord>       <dbl>      <dbl> <chr>           <dbl>  <dbl>\n 1 Before 1580731200 1580731440 a          1580731200  0.389\n 2 Before 1580731200 1580731440 a          1580731260 -0.816\n 3 Before 1580731200 1580731440 a          1580731320 -0.288\n 4 Before 1580731200 1580731440 a          1580731380  0.601\n 5 Before 1580731200 1580731440 a          1580731440  0.332\n 6 Before 1580731200 1580731440 b          1580731200 -1.04 \n 7 Before 1580731200 1580731440 b          1580731260  0.362\n 8 Before 1580731200 1580731440 b          1580731320 -0.802\n 9 Before 1580731200 1580731440 b          1580731380 -0.765\n10 Before 1580731200 1580731440 b          1580731440  0.569\n# ℹ 65 more rows\n```\n:::\n:::\n\n\n## Initial plots\n\nSo... what does a box plot of this data look like?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nWe see that our \"Impact\" dropped the mean and the Before and After periods are similar. Good, we coded it that way. What if we overlay the raw values?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot() +\n  geom_point(aes(color = individual))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Nudge things along\n\nWhat if we try to \"nudge\" the values away from the middle? Using the `position` argument of `geom_point`, we can provide how much we want the values \"nudged\". This argument takes the output of another function, `position_nudge`. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot() +\n  geom_point(aes(color = individual),\n             position = position_nudge(x = 3))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nThat... didn't quite do what we wanted.\n\n## How `ggplot2` creates space\n\nWe see above that all of points fall on a line in the dead center of the boxes. It's important to recognize how `ggplot2` allocates space in a box plot: the total width available to each box is equal to 1, running from -0.5 to 0.5, with 0 being the center of each variable (where the box whiskers are). This includes the space between boxes, so \\~2/3 of this space given for the box and 1/3 is given to space on either side.\n\nWe want to translate the observation time (within the given trial phase start/end range) to a range that can fit within the boxes of the box plot. Since 2/3 of the space provided for each box is given to the box, itself, this range is from -1/3 to +1/3. We can use this number to \"nudge\" the observation to the left (negative values) or right (positive values) of the center of the box.\n\n## Hack the space\n\nWe do this by re-scaling the data: multiplying the number of seconds into the a phase (`time - time.start`) by the amount of space available ($1/3 - (-1/3)$, or $2/3$), then dividing that by the length of time in that phase (`time.end - time.start`).\n\nNote that `position_nudge` is not aware of what data you're using in the rest of the `ggplot` call, so you have to give the full reference using `$`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data <- my_data |> \n  mutate(\n    nudge = (\n      ((time - time.start) * (1/3 - (-1/3))) /\n        (time.end - time.start)\n      )\n  )\n\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot() +\n  geom_point(aes(color = individual),\n             position = position_nudge(x = my_data$nudge))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nCloser! Since we want to align this with the left-hand side of the box, and that half of the box has a width of 1/3, we subtract 1/3.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_data <- my_data |> \n  mutate(\n    nudge = (\n      ((time - time.start) * (1/3 - (-1/3))) /\n        (time.end - time.start)\n      ) - 1/3\n  )\n\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot() +\n  geom_point(aes(color = individual),\n             position = position_nudge(x = my_data$nudge))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nThe points are where they're supposed to be, now we just have to connect them! Remember that the lines have to be nudged, too, so we need to provide the exact same arguments to `geom_line` as we did to `geom_point`.\n\n\n::: {.cell .preview-image}\n\n```{.r .cell-code}\nggplot(data = my_data, aes(x = phase, y = value)) +\n  geom_boxplot() +\n  geom_point(aes(color = individual),\n             position = position_nudge(x = my_data$nudge)) +\n  geom_line(aes(color = individual),\n            position = position_nudge(x = my_data$nudge))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n## Conclusion\n\nWell, is this ever chart junk. It's junk, though, that I find descriptive, hiding the original sin of cramming autocorrelated data into a box plot. I still feel that it has utility in spite of its dirty feeling. Maybe, *just maybe*, you'll see the time series box plot in a manuscript near you.\n\nOr not.",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}