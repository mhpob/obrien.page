<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.512">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mike O’Brien">

<title>Mike O’Brien - Point process models with mgcv and ’glm</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Mike O’Brien</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:mike@obrien.page"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mhpob"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research/packages.html"> 
<span class="menu-text">Packages</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../rugby/index.html"> 
<span class="menu-text">Rugby</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#rescale-data" id="toc-rescale-data" class="nav-link active" data-scroll-target="#rescale-data">Rescale data</a></li>
  <li><a href="#make-quadrature-points" id="toc-make-quadrature-points" class="nav-link" data-scroll-target="#make-quadrature-points">Make quadrature points</a></li>
  <li><a href="#create-weights-for-regression" id="toc-create-weights-for-regression" class="nav-link" data-scroll-target="#create-weights-for-regression">Create weights for regression</a></li>
  <li><a href="#model-fitting-intercept-only-stationary" id="toc-model-fitting-intercept-only-stationary" class="nav-link" data-scroll-target="#model-fitting-intercept-only-stationary">Model fitting: Intercept-only (stationary)</a>
  <ul class="collapse">
  <li><a href="#spatstatppm" id="toc-spatstatppm" class="nav-link" data-scroll-target="#spatstatppm"><code>spatstat::ppm</code></a></li>
  <li><a href="#statsglm" id="toc-statsglm" class="nav-link" data-scroll-target="#statsglm"><code>stats::glm</code></a></li>
  <li><a href="#mgcvgam" id="toc-mgcvgam" class="nav-link" data-scroll-target="#mgcvgam"><code>mgcv::gam</code></a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  <li><a href="#model-fitting-varying-over-space-non-stationary" id="toc-model-fitting-varying-over-space-non-stationary" class="nav-link" data-scroll-target="#model-fitting-varying-over-space-non-stationary">Model fitting: varying over space (non-stationary)</a>
  <ul class="collapse">
  <li><a href="#spatstatppm-1" id="toc-spatstatppm-1" class="nav-link" data-scroll-target="#spatstatppm-1"><code>spatstat::ppm</code></a></li>
  <li><a href="#statsglm-1" id="toc-statsglm-1" class="nav-link" data-scroll-target="#statsglm-1"><code>stats::glm</code></a></li>
  <li><a href="#mgcvgam-1" id="toc-mgcvgam-1" class="nav-link" data-scroll-target="#mgcvgam-1"><code>mgcv::gam</code></a></li>
  <li><a href="#comparison-1" id="toc-comparison-1" class="nav-link" data-scroll-target="#comparison-1">Comparison</a></li>
  </ul></li>
  <li><a href="#model-fitting-non-stationary-but-wiggly" id="toc-model-fitting-non-stationary-but-wiggly" class="nav-link" data-scroll-target="#model-fitting-non-stationary-but-wiggly">Model fitting: non-stationary, but wiggly</a>
  <ul class="collapse">
  <li><a href="#spatstatppm-2" id="toc-spatstatppm-2" class="nav-link" data-scroll-target="#spatstatppm-2"><code>spatstat::ppm</code></a></li>
  <li><a href="#mgcvgam-2" id="toc-mgcvgam-2" class="nav-link" data-scroll-target="#mgcvgam-2"><code>mgcv::gam</code></a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps… ?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Point process models with <code>mgcv</code> and ’glm</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://www.obrien.page">Mike O’Brien</a> <a href="mailto:mike@obrien.page" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0003-1420-6395" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatstat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.data</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.geom</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>spatstat.geom 3.2-7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.random</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>spatstat.random 3.2-2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.explore</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>spatstat.explore 3.2-5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rpart</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>spatstat.model 3.2-8</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: spatstat.linnet</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>spatstat.linnet 3.1-3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
spatstat 3.0-7 
For an introduction to spatstat, type 'beginner' </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-0. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.2, GDAL 3.6.2, PROJ 9.2.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Import <code>gorillas</code> data set from <code>spatstat.data</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">'gorillas'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This data set is a <code>ppp</code> object, which is a list containing gorilla nest locations by x and y coordinates in meters, a “window” which contains the bounding box of the data and the axes of the polygon in which gorilla nests were recorded, and a data frame of associated data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gorillas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "window"     "n"          "x"          "y"          "markformat"
[6] "marks"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gorillas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="rescale-data" class="level2">
<h2 class="anchored" data-anchor-id="rescale-data">Rescale data</h2>
<p>Locations are in meters, on the scale of 100-thousands of meters, but all of the action is within a few kilometers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(gorillas<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 580797.3 584945.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(gorillas<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 675238.7 678313.5</code></pre>
</div>
</div>
<p>Because the numbers are so big and the variation is comparatively small, I had issues getting convergence in <code>mgcv</code>. The locations need to be rescaled to fix this, here to kilometers easting and northing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gor_scale <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> gorillas<span class="sc">$</span>x <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> gorillas<span class="sc">$</span>y <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Doesn't seem like the window is actually needed here, but to make it 1:1</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="do">##    I'll rescale this too</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>gor_scale<span class="sc">$</span>window <span class="ot">&lt;-</span> <span class="fu">owin</span>(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(gorillas<span class="sc">$</span>window<span class="sc">$</span>bdry[[<span class="dv">1</span>]]<span class="sc">$</span>x <span class="sc">/</span> <span class="dv">1000</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">range</span>(gorillas<span class="sc">$</span>window<span class="sc">$</span>bdry[[<span class="dv">1</span>]]<span class="sc">$</span>y <span class="sc">/</span> <span class="dv">1000</span>),</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">poly =</span> <span class="fu">list</span>(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> gorillas<span class="sc">$</span>window<span class="sc">$</span>bdry[[<span class="dv">1</span>]]<span class="sc">$</span>x <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> gorillas<span class="sc">$</span>window<span class="sc">$</span>bdry[[<span class="dv">1</span>]]<span class="sc">$</span>y <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">unitname =</span> <span class="st">'kilometers'</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-quadrature-points" class="level2">
<h2 class="anchored" data-anchor-id="make-quadrature-points">Make quadrature points</h2>
<p>The idea of quadrature points is a completely new concept to me and I’m only now starting to <em>maybe</em> wrap my head around it so take anything I say with a large grain of salt. I have found <span class="citation" data-cites="renner2015">Renner et al. (<a href="#ref-renner2015" role="doc-biblioref">2015</a>)</span> to be a great reference in all of this. We often hear of needing “pseudoabsences” when modeling our presence-only data, but these are fraught with issues around model inference depending on how many, and where, these points are chosen. The authors suggest that we should switch from the idea of “pseudoabsences” to “quadrature points”, which philosophically changes the reason for using them from “inference about where animals aren’t” to “making the math in the model fitting process work”.</p>
<p>Some literature, including the documentation of the new <code>scampr</code> package that I’ve been leaning on for some of this (see <span class="citation" data-cites="dovers2023">Dovers et al. (<a href="#ref-dovers2023" role="doc-biblioref">2023a</a>)</span>; <span class="citation" data-cites="dovers2023a">Dovers et al. (<a href="#ref-dovers2023a" role="doc-biblioref">2023b</a>)</span>), also seem to think of quadrature points as analogous to the knots in a GAM smooth. This is a little more intuitive to me for few reasons: “rank reduction” becomes conceptually similar to lowering the <code>k</code> value in <code>mgcv</code>. As in: <code>mgcv</code> uses <code>k</code> as a maximum “rank” of a given smooth and then <a href="https://github.com/cran/mgcv/blob/master/src/magic.c">magically conducts rank reduction</a> until it gives you some nominally-optimal “rank” in the form of estimated degrees of freedom. So, <code>s(x, k = 5)</code> has reduced rank in comparison to <code>s(x, k=10)</code>; it’s easy to see where rank reduction becomes important when we’re looking at a varying spatial field and need to do something more like <code>s(x, y, k = 300)</code>. In fact, part of the algorithm of <code>mgcv</code>’s spatial Gaussian process smooths is to randomly sample 2000 data points in order to create a “reduced rank eigen approximation to the full basis” (check the details of <code>?mgcv::smooth.construct.gp.smooth.spec</code>).</p>
<p>There are many ways that have been suggested to create quadrature points, the main two being a grid or random selection. <code>spatstat</code> does this in the background for you, but we’ll need to make our own for the <code>glm</code> and <code>gam</code> fits. Here, I’m just going to randomly select 1000 points from the boundary provided in the <code>gorillas</code> data set. The selected quadrature points are in black, with the original gorilla next locations in red.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>gor_bnd <span class="ot">&lt;-</span> gor_scale<span class="sc">$</span>window<span class="sc">$</span>bdry[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'y'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_combine</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="st">'POLYGON'</span>) </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>gor_quad <span class="ot">&lt;-</span> gor_bnd <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sample</span>(<span class="dv">1000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span> </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gor_quad) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'x'</span>, <span class="st">'y'</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gor_bnd)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(gor_quad, <span class="at">cex =</span> <span class="fl">0.1</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(gor_scale, <span class="at">cex =</span> <span class="fl">0.2</span>, <span class="at">col =</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-weights-for-regression" class="level2">
<h2 class="anchored" data-anchor-id="create-weights-for-regression">Create weights for regression</h2>
<p><span class="citation" data-cites="renner2015">Renner et al. (<a href="#ref-renner2015" role="doc-biblioref">2015</a>)</span> provide a likelihood that allows Poisson point process models to be approximated as Poisson GLMs with a log link function.</p>
<p><span class="math display">\[
ln(\lambda) \sim \beta_0 +\beta_{...} + \epsilon
\]</span></p>
<p>where <span class="math inline">\(\lambda\)</span> is the intensity of the point process. They also offer a form of parameterizing the prior weights of the data so that it becomes “scale invariant” – modeling the intercept becomes less/non-dependent on the number of quadrature points selected. The “downweighted Poisson regression” (DWPR) they suggest assigns a very small weight to the observations and weight equivalent to the sampled area divided by the number of quadrature points to each quadrature point. The intensity of the point process is then proportional to the weighted observation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> the_data,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> the_data<span class="sc">$</span>wts</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or, since a GAM is just a fancy GLM,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gam</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> the_data,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> the_data<span class="sc">$</span>wts</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To create “<code>the_data</code>” properly, add weights to the observations…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>gor_scale_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> gor_scale<span class="sc">$</span>x,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> gor_scale<span class="sc">$</span>y,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a very small weight</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">wts =</span> <span class="fl">1e-6</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and n = 1 for the observation</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">1</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>…and to the quadrature points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Weight equal to the sampled area dividied by number of quadrature points</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>gor_quad<span class="sc">$</span>wts <span class="ot">&lt;-</span> <span class="fu">st_area</span>(gor_bnd) <span class="sc">/</span> <span class="fu">nrow</span>(gor_quad)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># and n = 0 as there was no observation</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>gor_quad<span class="sc">$</span>n <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, combine the observations and quadrature points into one data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>gor_scale_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  gor_scale_df,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  gor_quad</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-fitting-intercept-only-stationary" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-intercept-only-stationary">Model fitting: Intercept-only (stationary)</h2>
<p>First, we’ll fit a simple Poisson point process model that only has an intercept.</p>
<section id="spatstatppm" class="level3">
<h3 class="anchored" data-anchor-id="spatstatppm"><code>spatstat::ppm</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>gor_spst <span class="ot">&lt;-</span> <span class="fu">ppm</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ppp</span>(gor_scale<span class="sc">$</span>x, gor_scale<span class="sc">$</span>y, <span class="at">window =</span> gor_scale<span class="sc">$</span>window),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">interaction =</span> <span class="fu">Poisson</span>()</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: data contain duplicated points</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_spst)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Point process model
Fitted to data: ppp(gor_scale$x, gor_scale$y, window = gor_scale$window)
Fitting method: maximum likelihood
Model was fitted analytically
Call:
ppm.ppp(Q = ppp(gor_scale$x, gor_scale$y, window = gor_scale$window), 
    interaction = Poisson())
Edge correction: "border"
    [border correction distance r = 0 ]
--------------------------------------------------------------------------------
Quadrature scheme (Berman-Turner) = data + dummy + weights

Data pattern:
Planar point pattern:  647 points
Average intensity 32.6 points per square kilometers
Window: polygonal boundary
single connected closed polygon with 21 vertices
enclosing rectangle: [580.4579, 585.934] x [674.1728, 678.7392] kilometers
                     (5.476 x 4.566 kilometers)
Window area = 19.8737 square kilometers
Unit of length: 1 kilometers
Fraction of frame area: 0.795

Dummy quadrature points:
     64 x 64 grid of dummy points, plus 4 corner points
     dummy spacing: 0.08556315 x 0.07135048 kilometers

Original dummy parameters: =
Planar point pattern:  3324 points
Average intensity 167 points per square kilometers
Window: polygonal boundary
single connected closed polygon with 21 vertices
enclosing rectangle: [580.4579, 585.934] x [674.1728, 678.7392] kilometers
                     (5.476 x 4.566 kilometers)
Window area = 19.8737 square kilometers
Unit of length: 1 kilometers
Fraction of frame area: 0.795
Quadrature weights:
     (counting weights based on 64 x 64 array of rectangular tiles)
All weights:
    range: [0.000732, 0.0061]   total: 19.9
Weights on data points:
    range: [0.000763, 0.00305]  total: 1.36
Weights on dummy points:
    range: [0.000732, 0.0061]   total: 18.5
--------------------------------------------------------------------------------
FITTED :

Stationary Poisson process

---- Intensity: ----


Uniform intensity:
[1] 32.55566

            Estimate       S.E.  CI95.lo  CI95.hi Ztest     Zval
log(lambda) 3.482951 0.03931406 3.405897 3.560005   *** 88.59302

----------- gory details -----

Fitted regular parameters (theta):
log(lambda) 
   3.482951 

Fitted exp(theta):
log(lambda) 
   32.55566 </code></pre>
</div>
</div>
</section>
<section id="statsglm" class="level3">
<h3 class="anchored" data-anchor-id="statsglm"><code>stats::glm</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>gor_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_glm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = n/wts ~ 1, family = poisson(), data = gor_scale_df, 
    weights = gor_scale_df$wts)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  3.48292    0.03931    88.6   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 13370  on 1646  degrees of freedom
Residual deviance: 13370  on 1646  degrees of freedom
AIC: 13372

Number of Fisher Scoring iterations: 15</code></pre>
</div>
</div>
</section>
<section id="mgcvgam" class="level3">
<h3 class="anchored" data-anchor-id="mgcvgam"><code>mgcv::gam</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>gor_gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'REML'</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: poisson 
Link function: log 

Formula:
n/wts ~ 1

Parametric coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  3.48292    0.03931   88.59   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1


R-sq.(adj) =  -6.66e-16   Deviance explained = -1.36e-14%
-REML = 6687.5  Scale est. = 1         n = 1647</code></pre>
</div>
</div>
</section>
<section id="comparison" class="level3">
<h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">'ppm'</span>, <span class="st">'glm'</span>, <span class="st">'gam'</span>),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_intensity =</span> <span class="fu">c</span>(<span class="fu">coef</span>(gor_spst), <span class="fu">coef</span>(gor_glm), <span class="fu">coef</span>(gor_gam))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  method log_intensity
1    ppm      3.482951
2    glm      3.482919
3    gam      3.482919</code></pre>
</div>
</div>
<p>We got very similar results, and we used less than a third of the quadrature points. Good sign!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glm/gam quadrature points</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(gor_quad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ppm quadrature points</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>gor_spst<span class="sc">$</span>Q<span class="sc">$</span>dummy<span class="sc">$</span>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3324</code></pre>
</div>
</div>
</section>
</section>
<section id="model-fitting-varying-over-space-non-stationary" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-varying-over-space-non-stationary">Model fitting: varying over space (non-stationary)</h2>
<p>The previous model was “stationary”: no matter where we were in space, the intensity remained the same. Now we’ll try a non-stationary process, wherein the intensity depends on where we are in X/Y space.</p>
<p><span class="math display">\[
log(\lambda) \sim \beta_0 + \beta_1X + \beta_2Y + \beta_3XY + \epsilon
\]</span></p>
<section id="spatstatppm-1" class="level3">
<h3 class="anchored" data-anchor-id="spatstatppm-1"><code>spatstat::ppm</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>gor_spst_ns <span class="ot">&lt;-</span> <span class="fu">ppm</span>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ppp</span>(gor_scale<span class="sc">$</span>x, gor_scale<span class="sc">$</span>y, <span class="at">window =</span> gor_scale<span class="sc">$</span>window) <span class="sc">~</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span> <span class="sc">+</span> x <span class="sc">*</span> y,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">interaction =</span> <span class="fu">Poisson</span>()</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: data contain duplicated points</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_spst_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Point process model
Fitted to data: ppp(gor_scale$x, gor_scale$y, window = gor_scale$window)
Fitting method: maximum likelihood (Berman-Turner approximation)
Model was fitted using glm()
Algorithm converged
Call:
ppm.formula(Q = ppp(gor_scale$x, gor_scale$y, window = gor_scale$window) ~ 
    0 + x * y, interaction = Poisson())
Edge correction: "border"
    [border correction distance r = 0 ]
--------------------------------------------------------------------------------
Quadrature scheme (Berman-Turner) = data + dummy + weights

Data pattern:
Planar point pattern:  647 points
Average intensity 32.6 points per square kilometers
Window: polygonal boundary
single connected closed polygon with 21 vertices
enclosing rectangle: [580.4579, 585.934] x [674.1728, 678.7392] kilometers
                     (5.476 x 4.566 kilometers)
Window area = 19.8737 square kilometers
Unit of length: 1 kilometers
Fraction of frame area: 0.795

Dummy quadrature points:
     64 x 64 grid of dummy points, plus 4 corner points
     dummy spacing: 0.08556315 x 0.07135048 kilometers

Original dummy parameters: =
Planar point pattern:  3324 points
Average intensity 167 points per square kilometers
Window: polygonal boundary
single connected closed polygon with 21 vertices
enclosing rectangle: [580.4579, 585.934] x [674.1728, 678.7392] kilometers
                     (5.476 x 4.566 kilometers)
Window area = 19.8737 square kilometers
Unit of length: 1 kilometers
Fraction of frame area: 0.795
Quadrature weights:
     (counting weights based on 64 x 64 array of rectangular tiles)
All weights:
    range: [0.000732, 0.0061]   total: 19.9
Weights on data points:
    range: [0.000763, 0.00305]  total: 1.36
Weights on dummy points:
    range: [0.000732, 0.0061]   total: 18.5
--------------------------------------------------------------------------------
FITTED :

Nonstationary Poisson process

---- Intensity: ----

Log intensity: ~0 + x * y

Fitted trend coefficients:
            x             y           x:y 
-0.5658078263  0.3173808195  0.0003003385 

         Estimate         S.E.       CI95.lo       CI95.hi Ztest       Zval
x   -0.5658078263 4.341246e-02 -0.6508946924 -0.4807209602   *** -13.033304
y    0.3173808195 2.616352e-02  0.2661012541  0.3686603849   ***  12.130660
x:y  0.0003003385 7.451475e-05  0.0001542923  0.0004463847   ***   4.030592

----------- gory details -----

Fitted regular parameters (theta):
            x             y           x:y 
-0.5658078263  0.3173808195  0.0003003385 

Fitted exp(theta):
        x         y       x:y 
0.5679012 1.3735255 1.0003004 </code></pre>
</div>
</div>
</section>
<section id="statsglm-1" class="level3">
<h3 class="anchored" data-anchor-id="statsglm-1"><code>stats::glm</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>gor_glm_ns <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> x <span class="sc">*</span> y,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_glm_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = n/wts ~ 0 + x * y, family = poisson(), data = gor_scale_df, 
    weights = gor_scale_df$wts)

Coefficients:
      Estimate Std. Error z value Pr(&gt;|z|)    
x   -0.6514517  0.0451625 -14.425  &lt; 2e-16 ***
y    0.3184408  0.0261495  12.178  &lt; 2e-16 ***
x:y  0.0004251  0.0000748   5.683 1.33e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for poisson family taken to be 1)

    Null deviance: 16623  on 1647  degrees of freedom
Residual deviance: 13017  on 1644  degrees of freedom
AIC: 13023

Number of Fisher Scoring iterations: 16</code></pre>
</div>
</div>
</section>
<section id="mgcvgam-1" class="level3">
<h3 class="anchored" data-anchor-id="mgcvgam-1"><code>mgcv::gam</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>gor_gam_ns <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> x <span class="sc">*</span> y,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'REML'</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_gam_ns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: poisson 
Link function: log 

Formula:
n/wts ~ 0 + x * y

Parametric coefficients:
      Estimate Std. Error z value Pr(&gt;|z|)    
x   -0.6514517  0.0451625 -14.425  &lt; 2e-16 ***
y    0.3184408  0.0261495  12.178  &lt; 2e-16 ***
x:y  0.0004251  0.0000748   5.683 1.33e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1


R-sq.(adj) =  -0.00122   Deviance explained = 2.64%
-REML = 6528.8  Scale est. = 1         n = 1647</code></pre>
</div>
</div>
</section>
<section id="comparison-1" class="level3">
<h3 class="anchored" data-anchor-id="comparison-1">Comparison</h3>
<p>The coefficients are still close!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">c</span>(<span class="st">'ppm'</span>, <span class="st">'glm'</span>, <span class="st">'gam'</span>),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_1 =</span> <span class="fu">c</span>(<span class="fu">coef</span>(gor_spst_ns)[<span class="dv">1</span>], <span class="fu">coef</span>(gor_glm_ns)[<span class="dv">1</span>], <span class="fu">coef</span>(gor_gam_ns)[<span class="dv">1</span>]),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_2 =</span> <span class="fu">c</span>(<span class="fu">coef</span>(gor_spst_ns)[<span class="dv">2</span>], <span class="fu">coef</span>(gor_glm_ns)[<span class="dv">2</span>], <span class="fu">coef</span>(gor_gam_ns)[<span class="dv">2</span>]),</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">b_3 =</span> <span class="fu">c</span>(<span class="fu">coef</span>(gor_spst_ns)[<span class="dv">3</span>], <span class="fu">coef</span>(gor_glm_ns)[<span class="dv">3</span>], <span class="fu">coef</span>(gor_gam_ns)[<span class="dv">3</span>])</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  method        b_1       b_2          b_3
1    ppm -0.5658078 0.3173808 0.0003003385
2    glm -0.6514517 0.3184408 0.0004250712
3    gam -0.6514517 0.3184408 0.0004250712</code></pre>
</div>
</div>
</section>
</section>
<section id="model-fitting-non-stationary-but-wiggly" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting-non-stationary-but-wiggly">Model fitting: non-stationary, but wiggly</h2>
<section id="spatstatppm-2" class="level3">
<h3 class="anchored" data-anchor-id="spatstatppm-2"><code>spatstat::ppm</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>gor_spst_ns_gam <span class="ot">&lt;-</span> <span class="fu">ppm</span>(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ppp</span>(gor_scale<span class="sc">$</span>x, gor_scale<span class="sc">$</span>y, <span class="at">window =</span> gor_scale<span class="sc">$</span>window) <span class="sc">~</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">s</span>(x, y),</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">interaction =</span> <span class="fu">Poisson</span>(),</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">use.gam =</span> <span class="cn">TRUE</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: data contain duplicated points</code></pre>
</div>
</div>
<p>The summary evaluates every part of the fitted GAM, so I’ll just show the intercept and first five to get the gist.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_spst_ns_gam)<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: model was fitted by gam(); asymptotic variance calculation ignores
this</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>              Estimate      S.E.    CI95.lo    CI95.hi Ztest      Zval
(Intercept)  0.2697338 0.5989718 -0.9042294  1.4436970        0.450328
s(x,y).1    -1.5159392 0.5413861 -2.5770365 -0.4548419    ** -2.800107
s(x,y).2     2.3284316 1.4322184 -0.4786649  5.1355281        1.625752
s(x,y).3    -1.9494921 1.4397488 -4.7713479  0.8723637       -1.354050
s(x,y).4    -1.1205318 0.8929795 -2.8707394  0.6296758       -1.254824</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gor_spst_ns_gam, <span class="at">pause =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-22-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mgcvgam-2" class="level3">
<h3 class="anchored" data-anchor-id="mgcvgam-2"><code>mgcv::gam</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>gor_gam_ns_gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="fu">s</span>(x, y),</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'REML'</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_gam_ns_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: poisson 
Link function: log 

Formula:
n/wts ~ s(x, y)

Parametric coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   2.1592     0.2538   8.507   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
         edf Ref.df Chi.sq p-value    
s(x,y) 22.82  25.53  587.5  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  -0.014   Deviance explained = 12.7%
-REML = 5887.6  Scale est. = 1         n = 1647</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(gor_gam_ns_gam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Well… there are some differences here, on the order of 200 predicted individuals (~40% of total).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">predict</span>(gor_spst_ns_gam))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.094560e-10 3.311803e+02</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">predict</span>(gor_gam_ns_gam, <span class="at">type =</span> <span class="st">'response'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.187043e-05 4.357467e+02</code></pre>
</div>
</div>
<p>I think this comes down to the way in which <code>spatstat</code> calculates weights (likely more correctly), and that <code>spatstat</code> uses <code>quasi(link="log", variance="mu")</code> for its error family. The predictions between the two methods do get closer by doing this, though not as close as they were before. We also start getting into issues with quasilikelihood and not being able to use AIC, etc., so it’s not really desirable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>gor_gam_ns_gam_quasi <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  n<span class="sc">/</span>wts <span class="sc">~</span> <span class="fu">s</span>(x, y),</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">quasi</span>(<span class="at">link=</span><span class="st">"log"</span>, <span class="at">variance=</span><span class="st">"mu"</span>),</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> gor_scale_df,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> gor_scale_df<span class="sc">$</span>wts,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'REML'</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(gor_gam_ns_gam_quasi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: quasi 
Link function: log 

Formula:
n/wts ~ s(x, y)

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   2.7092     0.1258   21.53   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
        edf Ref.df     F p-value    
s(x,y) 14.9   18.8 35.74  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  -0.00908   Deviance explained = 12.2%
-REML = 8891.6  Scale est. = 1.0097    n = 1647</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(<span class="fu">predict</span>(gor_gam_ns_gam_quasi, <span class="at">type =</span> <span class="st">'response'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   0.05104336 317.09393438</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(gor_gam_ns_gam_quasi,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">fun =</span> <span class="cf">function</span>(.){</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">quasi</span>(<span class="at">link=</span><span class="st">"log"</span>, <span class="at">variance=</span><span class="st">"mu"</span>)<span class="sc">$</span><span class="fu">linkinv</span>(</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>         . <span class="sc">+</span> <span class="fu">coef</span>(gor_gam_ns_gam_quasi)[<span class="dv">1</span>]</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>     })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="lcgp-mgcv_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps… ?</h2>
<p><span class="math display">\[
log(\lambda) \sim \beta_0 + \beta_1X + \beta_2Y + \beta_3XY + \xi
\]</span></p>
<p>https://becarioprecario.bitbucket.io/spde-gitbook/ch-lcox.html point process with centered smooth?</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-dovers2023" class="csl-entry" role="listitem">
Dovers, Elliot, Wesley Brooks, Gordana C. Popovic, and David I. Warton. 2023a. <span>“Fast, Approximate Maximum Likelihood Estimation of Log-Gaussian Cox Processes.”</span> <em>Journal of Computational and Graphical Statistics</em> 32 (4): 1660–70. <a href="https://doi.org/10.1080/10618600.2023.2182311">https://doi.org/10.1080/10618600.2023.2182311</a>.
</div>
<div id="ref-dovers2023a" class="csl-entry" role="listitem">
———. 2023b. <span>“Fast, Approximate Maximum Likelihood Estimation of Log-Gaussian Cox Processes.”</span> <em>Journal of Computational and Graphical Statistics</em> 32 (4): 1660–70. <a href="https://doi.org/10.1080/10618600.2023.2182311">https://doi.org/10.1080/10618600.2023.2182311</a>.
</div>
<div id="ref-renner2015" class="csl-entry" role="listitem">
Renner, Ian W., Jane Elith, Adrian Baddeley, William Fithian, Trevor Hastie, Steven J. Phillips, Gordana Popovic, and David I. Warton. 2015. <span>“Point Process Models for Presence-Only Analysis.”</span> <em>Methods in Ecology and Evolution</em> 6 (4): 366–79. <a href="https://doi.org/10.1111/2041-210X.12352">https://doi.org/10.1111/2041-210X.12352</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.obrien\.page");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>